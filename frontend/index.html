<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Efficiency Platform Starter Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root" class="max-w-6xl mx-auto p-6"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      const defaultApiBase = localStorage.getItem('api_base') || 'http://localhost:8000';

      function Section({ title, children }) {
        return (
          <section className="bg-white rounded-lg shadow mb-6">
            <div className="border-b px-5 py-3 font-semibold">{title}</div>
            <div className="p-5">{children}</div>
          </section>
        );
      }

      function ApiConfig({ apiBase, setApiBase }) {
        const [value, setValue] = useState(apiBase);
        return (
          <div className="flex items-end gap-3">
            <div className="flex-1">
              <label className="block text-sm mb-1">API Base URL</label>
              <input
                className="w-full border rounded px-3 py-2"
                value={value}
                onChange={(e) => setValue(e.target.value)}
                placeholder="http://localhost:8000"
              />
            </div>
            <button
              className="px-4 py-2 rounded bg-slate-900 text-white"
              onClick={() => { setApiBase(value); localStorage.setItem('api_base', value); }}
            >Save</button>
          </div>
        );
      }

      function IngestForm({ apiBase, onIngest }) {
        const [sector, setSector] = useState('finance');
        const [metric, setMetric] = useState('latency_ms');
        const [value, setValue] = useState('123');

        async function submit(e) {
          e.preventDefault();
          const payload = { sector, metric_name: metric, value: Number(value) };
          const res = await fetch(`${apiBase}/api/v1/ingest`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          onIngest?.(data);
        }

        return (
          <form onSubmit={submit} className="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
              <label className="block text-sm mb-1">Sector</label>
              <select className="w-full border rounded px-3 py-2" value={sector} onChange={(e) => setSector(e.target.value)}>
                <option value="finance">finance</option>
                <option value="industrial">industrial</option>
                <option value="conglomerate">conglomerate</option>
                <option value="general">general</option>
                <option value="other">other</option>
              </select>
            </div>
            <div>
              <label className="block text-sm mb-1">Metric</label>
              <input className="w-full border rounded px-3 py-2" value={metric} onChange={(e) => setMetric(e.target.value)} placeholder="latency_ms" />
            </div>
            <div>
              <label className="block text-sm mb-1">Value</label>
              <input className="w-full border rounded px-3 py-2" value={value} onChange={(e) => setValue(e.target.value)} type="number" step="any" />
            </div>
            <div className="flex items-end">
              <button type="submit" className="w-full md:w-auto px-4 py-2 rounded bg-emerald-600 text-white">Ingest</button>
            </div>
          </form>
        );
      }

      function SeriesChart({ apiBase }) {
        const [sector, setSector] = useState('finance');
        const [metric, setMetric] = useState('latency_ms');
        const [series, setSeries] = useState([]);
        const canvasRef = useRef(null);
        const chartRef = useRef(null);

        async function loadSeries() {
          const url = new URL(`${apiBase}/api/v1/metrics`);
          url.searchParams.set('sector', sector);
          url.searchParams.set('metric_name', metric);
          const res = await fetch(url.toString());
          const data = await res.json();
          setSeries(data.series || []);
        }

        useEffect(() => {
          if (!canvasRef.current) return;
          const current = series[0];
          const labels = current ? current.points.map(p => new Date(p.ts)) : [];
          const values = current ? current.points.map(p => p.value) : [];

          if (chartRef.current) {
            chartRef.current.destroy();
            chartRef.current = null;
          }

          const ctx = canvasRef.current.getContext('2d');
          chartRef.current = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: `${sector} / ${metric}`,
                  data: values,
                  borderColor: 'rgb(37, 99, 235)',
                  backgroundColor: 'rgba(37, 99, 235, 0.2)',
                  tension: 0.2,
                }
              ]
            },
            options: {
              responsive: true,
              parsing: false,
              scales: {
                x: { type: 'time', time: { unit: 'minute' } },
                y: { beginAtZero: true }
              },
              plugins: { legend: { display: true } }
            }
          });
        }, [series]);

        return (
          <div className="space-y-3">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label className="block text-sm mb-1">Sector</label>
                <input className="w-full border rounded px-3 py-2" value={sector} onChange={(e) => setSector(e.target.value)} />
              </div>
              <div>
                <label className="block text-sm mb-1">Metric</label>
                <input className="w-full border rounded px-3 py-2" value={metric} onChange={(e) => setMetric(e.target.value)} />
              </div>
              <div className="flex items-end">
                <button className="w-full md:w-auto px-4 py-2 rounded bg-blue-600 text-white" onClick={loadSeries}>Load Series</button>
              </div>
            </div>
            <canvas ref={canvasRef} height="120"></canvas>
          </div>
        );
      }

      function SummaryPanel({ apiBase }) {
        const [sector, setSector] = useState('finance');
        const [metric, setMetric] = useState('latency_ms');
        const [summary, setSummary] = useState(null);

        async function loadSummary() {
          const url = new URL(`${apiBase}/api/v1/summary`);
          url.searchParams.set('sector', sector);
          url.searchParams.set('metric_name', metric);
          url.searchParams.set('window', '5');
          const res = await fetch(url.toString());
          const data = await res.json();
          setSummary(data);
        }

        return (
          <div className="space-y-3">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label className="block text-sm mb-1">Sector</label>
                <input className="w-full border rounded px-3 py-2" value={sector} onChange={(e) => setSector(e.target.value)} />
              </div>
              <div>
                <label className="block text-sm mb-1">Metric</label>
                <input className="w-full border rounded px-3 py-2" value={metric} onChange={(e) => setMetric(e.target.value)} />
              </div>
              <div className="flex items-end">
                <button className="w-full md:w-auto px-4 py-2 rounded bg-indigo-600 text-white" onClick={loadSummary}>Get Summary</button>
              </div>
            </div>
            {summary && (
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div className="p-3 bg-slate-100 rounded">
                  <div className="text-xs text-slate-500">Count</div>
                  <div className="text-lg font-semibold">{summary.count}</div>
                </div>
                <div className="p-3 bg-slate-100 rounded">
                  <div className="text-xs text-slate-500">Min</div>
                  <div className="text-lg font-semibold">{summary.minimum?.toFixed(3)}</div>
                </div>
                <div className="p-3 bg-slate-100 rounded">
                  <div className="text-xs text-slate-500">Max</div>
                  <div className="text-lg font-semibold">{summary.maximum?.toFixed(3)}</div>
                </div>
                <div className="p-3 bg-slate-100 rounded">
                  <div className="text-xs text-slate-500">Avg</div>
                  <div className="text-lg font-semibold">{summary.average?.toFixed(3)}</div>
                </div>
                <div className="p-3 bg-slate-100 rounded col-span-2 md:col-span-4">
                  <div className="text-xs text-slate-500">Trend Slope</div>
                  <div className="text-lg font-semibold">{summary.trend_slope?.toFixed(5)}</div>
                </div>
              </div>
            )}
          </div>
        );
      }

      function AnomaliesPanel({ apiBase }) {
        const [sector, setSector] = useState('finance');
        const [metric, setMetric] = useState('latency_ms');
        const [threshold, setThreshold] = useState(3);
        const [anomalies, setAnomalies] = useState(null);

        async function loadAnomalies() {
          const url = new URL(`${apiBase}/api/v1/anomalies`);
          url.searchParams.set('sector', sector);
          url.searchParams.set('metric_name', metric);
          url.searchParams.set('threshold_z', String(threshold));
          const res = await fetch(url.toString());
          const data = await res.json();
          setAnomalies(data);
        }

        return (
          <div className="space-y-3">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
              <div>
                <label className="block text-sm mb-1">Sector</label>
                <input className="w-full border rounded px-3 py-2" value={sector} onChange={(e) => setSector(e.target.value)} />
              </div>
              <div>
                <label className="block text-sm mb-1">Metric</label>
                <input className="w-full border rounded px-3 py-2" value={metric} onChange={(e) => setMetric(e.target.value)} />
              </div>
              <div>
                <label className="block text-sm mb-1">Z-Threshold</label>
                <input className="w-full border rounded px-3 py-2" type="number" step="any" value={threshold} onChange={(e) => setThreshold(e.target.value)} />
              </div>
              <div className="flex items-end">
                <button className="w-full md:w-auto px-4 py-2 rounded bg-rose-600 text-white" onClick={loadAnomalies}>Detect</button>
              </div>
            </div>

            {anomalies && (
              <div className="space-y-2">
                <div className="text-sm text-slate-600">Found {anomalies.anomalies?.length || 0} anomalies</div>
                <ul className="divide-y">
                  {(anomalies.anomalies || []).map((a, i) => (
                    <li key={i} className="py-2 flex justify-between text-sm">
                      <span>{new Date(a.ts).toLocaleString()}</span>
                      <span>value: <span className="font-mono">{a.value}</span></span>
                      <span>z: <span className="font-mono">{a.z_score.toFixed(3)}</span></span>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        );
      }

      function OptimizePanel({ apiBase }) {
        const [sector, setSector] = useState('finance');
        const [metric, setMetric] = useState('latency_ms');
        const [suggestions, setSuggestions] = useState([]);

        async function optimize() {
          const res = await fetch(`${apiBase}/api/v1/optimize`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sector, metric_name: metric })
          });
          const data = await res.json();
          setSuggestions(data.suggestions || []);
        }

        return (
          <div className="space-y-3">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              <div>
                <label className="block text-sm mb-1">Sector</label>
                <input className="w-full border rounded px-3 py-2" value={sector} onChange={(e) => setSector(e.target.value)} />
              </div>
              <div>
                <label className="block text-sm mb-1">Metric</label>
                <input className="w-full border rounded px-3 py-2" value={metric} onChange={(e) => setMetric(e.target.value)} />
              </div>
              <div className="flex items-end">
                <button className="w-full md:w-auto px-4 py-2 rounded bg-emerald-700 text-white" onClick={optimize}>Get Suggestions</button>
              </div>
            </div>
            <ul className="space-y-2">
              {suggestions.map((s, i) => (
                <li key={i} className="p-3 bg-emerald-50 border border-emerald-200 rounded">
                  <div className="font-semibold">{s.title} <span className="text-xs text-emerald-700">({s.estimated_impact})</span></div>
                  <div className="text-sm text-slate-700">{s.description}</div>
                </li>
              ))}
            </ul>
          </div>
        );
      }

      function App() {
        const [apiBase, setApiBase] = useState(defaultApiBase);

        useEffect(() => {
          // Chart.js time scale needs adapter; fallback by formatting labels ourselves if missing
          if (!Chart.registry.adapters.date) {
            // No-op; Chart will still render using raw Date labels
          }
        }, []);

        function handleIngest(d) {
          // no-op; user feedback could be added
        }

        return (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <h1 className="text-2xl font-semibold">Efficiency Platform Starter</h1>
              <div className="text-sm text-slate-500">Backend: FastAPI • Frontend: React + Tailwind + Chart.js</div>
            </div>

            <Section title="API Configuration">
              <ApiConfig apiBase={apiBase} setApiBase={setApiBase} />
              <div className="text-xs text-slate-500 mt-2">Current: {apiBase}</div>
            </Section>

            <Section title="Ingest Metric">
              <IngestForm apiBase={apiBase} onIngest={handleIngest} />
              <div className="text-xs text-slate-500 mt-2">POST /api/v1/ingest — send a data point {'{ sector, metric_name, value }'}</div>
            </Section>

            <Section title="Time Series">
              <SeriesChart apiBase={apiBase} />
              <div className="text-xs text-slate-500 mt-2">GET /api/v1/metrics — fetch series for sector/metric</div>
            </Section>

            <Section title="Summary">
              <SummaryPanel apiBase={apiBase} />
              <div className="text-xs text-slate-500 mt-2">GET /api/v1/summary — min/max/avg + moving average trend</div>
            </Section>

            <Section title="Anomalies">
              <AnomaliesPanel apiBase={apiBase} />
              <div className="text-xs text-slate-500 mt-2">GET /api/v1/anomalies — z-score anomaly detection</div>
            </Section>

            <Section title="Optimization Suggestions">
              <OptimizePanel apiBase={apiBase} />
              <div className="text-xs text-slate-500 mt-2">POST /api/v1/optimize — sector-aware recommendations</div>
            </Section>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>